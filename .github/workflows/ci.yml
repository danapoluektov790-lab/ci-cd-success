name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  create-project:
    runs-on: ubuntu-latest
    name: ðŸ—‚ï¸ Create Project Structure
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“ Create project structure
      run: |
        echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
        mkdir -p src tests
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ calculator.py
        cat > src/calculator.py << 'EOF'
class Calculator:
    """
    ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ CI/CD
    """
    
    def add(self, a, b):
        """Ð¡Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð²ÑƒÑ… Ñ‡Ð¸ÑÐµÐ»"""
        return a + b

    def subtract(self, a, b):
        """Ð’Ñ‹Ñ‡Ð¸Ñ‚Ð°Ð½Ð¸Ðµ Ð´Ð²ÑƒÑ… Ñ‡Ð¸ÑÐµÐ»"""
        return a - b

    def multiply(self, a, b):
        """Ð£Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð²ÑƒÑ… Ñ‡Ð¸ÑÐµÐ»"""
        return a * b

    def divide(self, a, b):
        """Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ Ð´Ð²ÑƒÑ… Ñ‡Ð¸ÑÐµÐ»"""
        if b == 0:
            raise ValueError("Cannot divide by zero")
        return a / b

    def power(self, a, b):
        """Ð’Ð¾Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð² ÑÑ‚ÐµÐ¿ÐµÐ½ÑŒ"""
        return a ** b
EOF
        echo "âœ… src/calculator.py ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ“„ Create test_calculator.py
      run: |
        cat > tests/test_calculator.py << 'EOF'
import pytest
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.calculator import Calculator

class TestCalculator:
    def setup_method(self):
        self.calc = Calculator()

    def test_add(self):
        assert self.calc.add(2, 3) == 5
        assert self.calc.add(-1, 1) == 0

    def test_subtract(self):
        assert self.calc.subtract(5, 3) == 2
        assert self.calc.subtract(0, 5) == -5

    def test_multiply(self):
        assert self.calc.multiply(3, 4) == 12
        assert self.calc.multiply(0, 5) == 0

    def test_divide(self):
        assert self.calc.divide(6, 3) == 2
        assert self.calc.divide(5, 2) == 2.5

    def test_divide_by_zero(self):
        with pytest.raises(ValueError):
            self.calc.divide(5, 0)

    def test_power(self):
        assert self.calc.power(2, 3) == 8
        assert self.calc.power(5, 0) == 1
EOF
        echo "âœ… tests/test_calculator.py ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ“„ Create requirements.txt
      run: |
        cat > requirements.txt << 'EOF'
pytest==7.0.0
pytest-cov==3.0.0
flake8==6.0.0
bandit==1.7.5
EOF
        echo "âœ… requirements.txt ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ“„ Create README.md
      run: |
        cat > README.md << 'EOF'
# CI/CD Student Project

![CI Status](https://github.com/${{ github.repository }}/actions/workflows/ci.yml/badge.svg)

ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ CI/CD pipeline Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼.

## Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
- `src/calculator.py` - Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð´ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
- `tests/test_calculator.py` - Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
- `.github/workflows/ci.yml` - ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ CI/CD

## Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
- Ð¡Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
- Ð’Ñ‹Ñ‡Ð¸Ñ‚Ð°Ð½Ð¸Ðµ
- Ð£Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ
- Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ
- Ð’Ð¾Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð² ÑÑ‚ÐµÐ¿ÐµÐ½ÑŒ

## CI/CD Pipeline Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚:
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð° Python 3.8, 3.9, 3.10
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð° (flake8)
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ (bandit)
- âœ… ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÐºÐ¾Ð´Ð°
- âœ… Ð‘ÐµÐ¹Ð´Ð¶ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
EOF
        echo "âœ… README.md ÑÐ¾Ð·Ð´Ð°Ð½"

  test:
    runs-on: ubuntu-latest
    needs: create-project
    name: ðŸ§ª Run Tests
    
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ Python ${{ matrix.python-version }}"

    - name: ðŸ§ª Run tests with pytest
      run: |
        echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð° Python ${{ matrix.python-version }}..."
        pytest tests/ -v
        echo "âœ… Ð¢ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

    - name: ðŸ“Š Run tests with coverage
      run: |
        echo "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸..."
        pytest tests/ --cov=src --cov-report=xml
        echo "âœ… ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true

  lint:
    runs-on: ubuntu-latest
    needs: test
    name: ðŸ” Code Linting
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: ðŸ“¦ Install flake8
      run: |
        pip install flake8
        echo "âœ… Flake8 ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

    - name: ðŸ” Run flake8 linting
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð¸Ð»ÑŒ ÐºÐ¾Ð´Ð°..."
        flake8 src/ tests/ --count --show-source --statistics --max-line-length=100
        echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"

  security:
    runs-on: ubuntu-latest
    needs: test
    name: ðŸ”’ Security Scan
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: ðŸ“¦ Install bandit
      run: |
        pip install bandit
        echo "âœ… Bandit ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

    - name: ðŸ”’ Run security scan
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ð´Ð°..."
        bandit -r src/ -f html -o security-report.html
        echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"

    - name: ðŸ’¾ Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.html

  deploy:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main'
    name: ðŸš€ Deploy
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸš€ Deploy simulation
      run: |
        echo "âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!"
        echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
        echo "ðŸ“¦ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ"
        echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

  notify:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: always()
    name: ðŸ“¢ Notifications
    
    steps:
    - name: ðŸ“Š Workflow status
      run: |
        echo "ðŸŽ‰ CI/CD Pipeline Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
        echo "ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:"
        echo "   Ð¢ÐµÑÑ‚Ñ‹: ${{ needs.test.result }}"
        echo "   Ð›Ð¸Ð½Ñ‚Ð¸Ð½Ð³: ${{ needs.lint.result }}"
        echo "   Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ: ${{ needs.security.result }}"
        echo ""
        echo "âœ… Ð’ÑÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ!"
